# SCML2 Shared Memory Integration - Technical Findings

## Date: 2026-02-09

## Objective
Integrate `scml2::memory` into the test harness to enable cross-socket data verification in E2E tests, as requested by user based on SCML2 Reference Manual guidance.

## Approach Attempted

### 1. Initial Design (from SCML2_SHARED_MEMORY_SOLUTION.md)
- Create `scml2::memory` object (4GB)
- Create `tlm2_gp_target_adapter` instances for PCIe, NOC, SMN sockets
- Bind all three adapters to the SAME shared memory
- Connect DUT initiator sockets to these adapters

### 2. Implementation Attempts

#### Attempt A: Direct socket creation in test class
**Error:** `(E100) port specified outside of module`  
**Cause:** SystemC requires all sockets/ports to be created within an `sc_module`

#### Attempt B: Wrap in SC_MODULE (SharedMemoryModule)
**Error:** `(E126) sc_export instance already bound`  
**Cause:** Test harness auto-binds DUT initiator sockets during construction

#### Attempt C: Override `do_initialize_test_group()` to bind before parent
**Error:** `(E126) sc_export instance already bound`  
**Cause:** Sockets are bound even earlier in the DUT or harness construction phase

## Root Cause Analysis

### SCML2 Test Framework Architecture
1. **Auto-Generated Test Harness** (`Keranous_pcie_tileTestHarness.h`):
   - Created by Synopsys TLM Creator
   - Automatically binds all DUT sockets during test group initialization
   - Uses mirror model for transaction monitoring (NOT data storage)

2. **Mirror Model Behavior**:
   - Intercepts transactions for verification/coverage
   - Does NOT provide shared memory between sockets
   - Each socket sees its own isolated address space

3. **Socket Binding Rules**:
   - SystemC/TLM2 sockets can only be bound ONCE
   - Once bound, re-binding generates E126 error
   - Binding happens during elaboration phase (constructor/before_end_of_elaboration)

### Why Standard Approach Doesn't Work
```
DUT Constructor → Harness Constructor → do_initialize_test_group()
                                    ↑
                         Sockets already bound here
```

By the time we can override `do_initialize_test_group()`, the DUT's initiator sockets are already bound to the mirror model's target sockets.

## Alternative Solutions Evaluated

### Option 1: Modify Auto-Generated Test Harness
**Status:** User explicitly stated "TestHarness is autogenerated, you need to make changes in Keranous_pcie_tileTest.cc"  
**Conclusion:** Not viable per user constraint

### Option 2: Create Custom Test Harness (Non-SCML2)
**Description:**  
- Write a completely custom SystemC testbench
- Instantiate DUT directly (not via SCML2 test_group)
- Create shared memory before DUT instantiation
- Bind DUT sockets to shared memory manually

**Pros:**
- Full control over socket bindings
- True cross-socket data verification possible
- Follows SCML2 Reference Manual examples exactly

**Cons:**
- Loses SCML2 testing framework benefits (coverage, assertions, test infrastructure)
- Significant rewrite of all 81 tests
- Different test execution model

### Option 3: Parallel Memory for Test-Side Verification Only
**Description:**  
- Create shared memory module
- Tests write expected data to memory
- Tests read DUT outputs and compare with memory
- DUT still uses mirror model (no real memory backing)

**Pros:**
- No socket binding conflicts
- Can demonstrate verification methodology
- Minimal test framework changes

**Cons:**
- Cannot verify data actually flows through DUT correctly
- Tests are checking test logic, not DUT behavior
- Doesn't solve the original problem

### Option 4: System-Level Integration Test
**Description:**  
- Create separate system-level testbench outside SCML2
- Include actual memory models (DDR, SRAM, etc.)
- Connect DUT to real memory via TLB translations
- Run comprehensive data flow tests

**Pros:**
- True end-to-end verification with data integrity
- Matches real SoC integration scenario
- Can verify performance, latency, data correctness

**Cons:**
- Separate test infrastructure
- Not integrated with current unit test suite
- More complex setup

## Current Test Capabilities

### What CAN Be Verified (Current State)
1. **Transaction Routing**: PCIe → TLB → NOC (transaction completes)
2. **Address Translation**: TLB configuration correctness
3. **Control Flow**: Enable/disable signals, isolation modes
4. **Error Handling**: DECERR responses, invalid TLB entries
5. **Protocol Compliance**: Transaction completion, response codes

### What CANNOT Be Verified (SCML2 Limitation)
1. **Data Integrity**: Payload data preservation through tile
2. **Cross-Socket Data Flow**: Write via PCIe, read via NOC (same data)
3. **Memory Coherency**: Multiple paths accessing same memory location
4. **Actual Memory Operations**: No real storage backend

## Recommendations

### Immediate Action
Document the SCML2 framework limitation and current test coverage in:
- `E2E_TEST_RETROFIT_RESULTS.md`
- `TEST_VERIFICATION_REQUIREMENTS.md`
- Test plan updates

### Short-Term Solution
Enhance current tests with:
- Explicit comments noting data verification limitation
- Transaction completion verification (current capability)
- Address translation verification via configuration readback
- Protocol correctness checks

### Long-Term Solution (Recommended)
Create a **separate system-level test suite**:
1. New directory: `Keraunos_PCIe_tile/Tests/SystemLevel/`
2. Custom SystemC testbench with real memory models
3. Full data integrity verification
4. Integration with VDK environment (if applicable)
5. Performance benchmarking capability

This provides:
- Unit tests (current SCML2 suite): Fast, comprehensive, protocol-focused
- System tests (new suite): Slower, targeted, data-integrity-focused

## Files Modified During Investigation
- `/localdev/pdroy/keraunos_pcie_workspace/Keraunos_PCIe_tile/Tests/Unittests/Keranous_pcie_tileTest.cc`
  - Added `SharedMemoryModule` (SC_MODULE wrapper)
  - Attempted `do_initialize_test_group()` override
  - Modified test cases for memory access

## Next Steps

**User Decision Required:**
1. Accept current SCML2 test limitations and document thoroughly?
2. Proceed with separate system-level testbench creation?
3. Investigate commercial test framework alternatives (e.g., Synopsys VDK platform tests)?
4. Consult Synopsys support for SCML2 shared memory integration patterns?

## References
- `doc/PAVP_SCMLRef.md` - SCML2 Reference Manual (consulted for `scml2::memory` usage)
- `Keraunos_PCIe_tile/Tests/Unittests/Keranous_pcie_tileTestHarness.h` - Auto-generated test harness
- `SCML2_SHARED_MEMORY_SOLUTION.md` - Original proposed solution (not viable in current framework)
